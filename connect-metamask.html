<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Connect MetaMask - UNERA</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700;800&family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Enhanced Auth CSS -->
    <link rel="stylesheet" href="auth-enhanced.css">
    
    <style>
        .connection-steps {
            background: var(--neutral-100);
            border-radius: var(--radius-xl);
            padding: 1.5rem;
            margin: 2rem 0;
        }
        
        .connection-steps h4 {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 1rem;
        }
        
        .connection-steps ol {
            margin: 0;
            padding-left: 1.5rem;
            list-style: decimal;
        }
        
        .connection-steps li {
            font-size: 0.938rem;
            color: var(--text-secondary);
            line-height: 1.8;
            margin-bottom: 0.5rem;
        }
        
        .connection-steps li:last-child {
            margin-bottom: 0;
        }
        
        .connection-status {
            padding: 1.5rem;
            border-radius: var(--radius-lg);
            text-align: center;
            display: none;
            margin: 1.5rem 0;
        }
        
        .connection-status.connecting {
            display: block;
            background: rgba(14, 165, 233, 0.1);
            color: var(--primary-blue);
        }
        
        .connection-status.success {
            display: block;
            background: rgba(16, 185, 129, 0.1);
            color: var(--primary-green);
        }
        
        .connection-status.error {
            display: block;
            background: rgba(239, 68, 68, 0.1);
            color: var(--error);
        }
        
        .status-icon {
            font-size: 3rem;
            margin-bottom: 0.5rem;
        }
        
        .security-notice {
            background: rgba(16, 185, 129, 0.05);
            border-left: 4px solid var(--primary-green);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            margin: 2rem 0;
        }
        
        .security-notice h4 {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .security-notice p {
            font-size: 0.875rem;
            color: var(--text-secondary);
            line-height: 1.6;
            margin: 0;
        }
        
        .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid rgba(14, 165, 233, 0.2);
            border-top-color: var(--primary-blue);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            display: inline-block;
            margin: 0 auto;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Skip Link -->
    <a href="#main-content" class="skip-link">Skip to main content</a>

    <!-- Header -->
    <header class="header">
        <div class="header-left">
            <svg class="logo-icon" viewBox="0 0 140 140" xmlns="http://www.w3.org/2000/svg">
                <circle cx="70" cy="70" r="60" fill="#14B8A6"/>
                <circle cx="70" cy="70" r="45" fill="#2DD4BF"/>
                <circle cx="70" cy="70" r="30" fill="#5EEAD4"/>
                <circle cx="70" cy="70" r="15" fill="#FFFFFF"/>
            </svg>
            <span class="logo-text">UNERA</span>
        </div>
        <a href="signup_2.html" class="back-btn">
            <svg viewBox="0 0 24 24" fill="none">
                <path d="M19 12H5M5 12L12 19M5 12L12 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            Back
        </a>
    </header>

    <!-- Main Content -->
    <main id="main-content" class="auth-container">
        <div class="auth-card">
            <!-- Auth Header -->
            <div class="auth-header">
                <div class="logo-badge">
                    <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                        <path d="M21 12a9 9 0 1 1-6.219-8.56" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </div>
                <h1 class="auth-title">Connect MetaMask</h1>
                <p class="auth-subtitle">Connect your MetaMask wallet to continue</p>
            </div>

            <!-- Connection Status -->
            <div class="connection-status" id="connectionStatus"></div>

            <!-- Connection Steps -->
            <div class="connection-steps">
                <h4>Connection Steps:</h4>
                <ol>
                    <li>Click "Connect" to open MetaMask extension</li>
                    <li>Select the account(s) you want to connect</li>
                    <li>Approve the connection request in MetaMask</li>
                    <li>Your wallet will be connected automatically</li>
                </ol>
            </div>

            <!-- Security Notice -->
            <div class="security-notice">
                <h4>
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 20px; height: 20px;">
                        <path d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    Secure Connection
                </h4>
                <p>
                    UNERA will never ask for your seed phrase or private keys. 
                    Only connect your wallet if you see this request in the official MetaMask extension.
                </p>
            </div>

            <!-- Connect Button -->
            <button class="submit-btn sticky-cta" id="connectBtn" onclick="initiateConnection()">
                Connect MetaMask
            </button>

            <!-- Alternative -->
            <div style="text-align: center; margin-top: 2rem; padding-top: 2rem; border-top: 1px solid var(--border-subtle);">
                <p style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.75rem;">
                    Don't have MetaMask installed?
                </p>
                <a href="https://metamask.io/download/" target="_blank" rel="noopener noreferrer" 
                   style="color: var(--primary-green); font-weight: 600; text-decoration: underline; font-size: 0.938rem;">
                    Download MetaMask ‚Üí
                </a>
            </div>
        </div>
    </main>

    <!-- Auth Flow Manager -->
    <script src="auth-flow.js"></script>

    <!-- JavaScript -->
    <script>
        console.log('ü¶ä MetaMask Connection Page Loaded');

        // Get flow type from URL (signup or login)
        const urlParams = new URLSearchParams(window.location.search);
        const flowType = urlParams.get('flow') || 'signup'; // Default to signup
        
        console.log(`üîê Flow type: ${flowType}`);

        // For testing/demo: Skip MetaMask detection check
        // In production, you would check for actual MetaMask installation
        window.addEventListener('load', () => {
            // MetaMask detection disabled for testing
            console.log('‚úÖ Ready to simulate MetaMask connection');
        });

        // Initiate connection
        async function initiateConnection() {
            const btn = document.getElementById('connectBtn');
            
            // Show connecting state
            btn.classList.add('loading');
            btn.disabled = true;
            showStatus('connecting', 'üîÑ', 'Connecting...', 'Please approve the connection in MetaMask');
            
            try {
                console.log('ü¶ä Requesting MetaMask connection...');
                
                // FOR TESTING/DEMO: Try real MetaMask first, fallback to simulation
                let address;
                
                if (typeof window.ethereum !== 'undefined') {
                    // Real MetaMask is installed - use it
                    try {
                        const accounts = await window.ethereum.request({ 
                            method: 'eth_requestAccounts' 
                        });
                        
                        if (accounts.length > 0) {
                            address = accounts[0];
                            console.log('‚úÖ Connected to real MetaMask:', address);
                        }
                    } catch (metamaskError) {
                        console.log('‚ö†Ô∏è MetaMask connection failed, using simulation');
                        // Fall through to simulation
                    }
                }
                
                // If no real MetaMask connection, simulate one
                if (!address) {
                    console.log('üé≠ Simulating MetaMask connection for testing...');
                    
                    // Simulate connection delay (like real MetaMask)
                    await new Promise(resolve => setTimeout(resolve, 1500));
                    
                    // Generate a mock wallet address
                    address = '0x742d' + Math.random().toString(16).slice(2, 10) + '3a8f';
                    console.log('‚úÖ Simulated connection:', address);
                }
                
                // Store connection info
                localStorage.setItem('isLoggedIn', 'true');
                localStorage.setItem('emailVerified', 'true');
                localStorage.setItem('walletAddress', address);
                localStorage.setItem('walletType', 'metamask');
                localStorage.setItem('userName', `User ${address.slice(2, 6)}`);
                localStorage.setItem('signupMethod', 'metamask');
                
                // Show success
                showStatus('success', '‚úÖ', 'Connected Successfully!', `Wallet: ${address.slice(0, 6)}...${address.slice(-4)}`);
                
                btn.classList.remove('loading');
                btn.classList.add('success');
                btn.textContent = 'Connected!';
                
                // Haptic feedback
                if (window.navigator.vibrate) {
                    window.navigator.vibrate([10, 50, 10]);
                }
                
                // Redirect based on flow type
                setTimeout(() => {
                    if (flowType === 'login') {
                        // Existing user - check if 2FA is enabled
                        const has2FA = localStorage.getItem('2faEnabled') === 'true';
                        if (has2FA) {
                            console.log('üîê Redirecting to 2FA verification...');
                            window.location.href = 'verify-2fa.html?from=metamask';
                        } else {
                            console.log('üìä Redirecting to dashboard...');
                            window.location.href = 'dashboard-enhanced.html?welcome=back';
                        }
                    } else {
                        // New user - go to 2FA setup
                        console.log('üîê Redirecting to 2FA setup...');
                        window.location.href = 'setup-2fa.html?from=metamask';
                    }
                }, 1500);
                
            } catch (error) {
                console.error('‚ùå MetaMask connection error:', error);
                
                btn.classList.remove('loading');
                btn.disabled = false;
                
                // Show error
                let errorMessage = error.message;
                if (error.code === 4001) {
                    errorMessage = 'You rejected the connection request. Please try again.';
                } else if (error.code === -32002) {
                    errorMessage = 'MetaMask is already processing a request. Please check your extension.';
                }
                
                showStatus('error', '‚ùå', 'Connection Failed', errorMessage);
            }
        }

        // Show status message
        function showStatus(type, icon, title, message) {
            const status = document.getElementById('connectionStatus');
            status.className = `connection-status ${type}`;
            status.innerHTML = `
                <div class="status-icon">${icon}</div>
                <div style="font-weight: 600; margin-bottom: 0.5rem;">${title}</div>
                <div style="font-size: 0.875rem; opacity: 0.9;">${message}</div>
            `;
        }

        // Handle MetaMask events
        if (typeof window.ethereum !== 'undefined') {
            window.ethereum.on('accountsChanged', (accounts) => {
                console.log('üë§ Account changed:', accounts);
                if (accounts.length === 0) {
                    console.log('üö™ Disconnected');
                    showStatus('error', '‚ö†Ô∏è', 'Disconnected', 'MetaMask was disconnected');
                }
            });

            window.ethereum.on('chainChanged', (chainId) => {
                console.log('üîó Chain changed:', chainId);
            });
        }
    </script>
</body>
</html>
